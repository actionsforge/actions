name: Kubernetes Manifest Validation

on:
  pull_request:
    paths:
      - "Chart.yaml"
      - "values.yaml"
      - "templates/**"
      - ".github/workflows/k8s-manifest-validate.yml"
  workflow_call:
    inputs:
      chart_dir:
        description: "Chart directory (relative path)"
        type: string
        required: false
        default: "."
      helm_version:
        description: "Helm version (e.g., 3.15.4 or latest)"
        type: string
        required: false
        default: "latest"
      release_name:
        description: "Release name used for rendering"
        type: string
        required: false
        default: "test-release"
      namespace:
        description: "Namespace used for rendering (sets .Release.Namespace)"
        type: string
        required: false
        default: "default"
      values_file:
        description: "Optional values file (relative path). If empty, no -f is used"
        type: string
        required: false
        default: ""
      kube_version:
        description: "Optional Kubernetes version for rendering (e.g., 1.29.0). If empty, not set"
        type: string
        required: false
        default: ""
      include_crds:
        description: "Include CRDs in rendered output"
        type: boolean
        required: false
        default: false
      fail_on_empty_render:
        description: "Fail if rendering produces zero resources"
        type: boolean
        required: false
        default: true
      enable_kubeconform:
        description: "Enable schema validation with kubeconform"
        type: boolean
        required: false
        default: false
      kubeconform_kubernetes_version:
        description: "Kubernetes version for kubeconform (e.g., 1.29.0). Defaults to kube_version if set"
        type: string
        required: false
        default: ""

permissions:
  contents: read

jobs:
  validate:
    name: Validate Rendered Kubernetes Manifests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: ${{ inputs.helm_version || 'latest' }}

      - name: Build chart dependencies
        shell: bash
        run: |
          set -euo pipefail
          cd "${{ inputs.chart_dir || '.' }}"

          if [ ! -f "Chart.yaml" ]; then
            echo "⚠️  Chart.yaml not found, skipping dependency build"
            exit 0
          fi

          echo "Building chart dependencies from Chart.lock..."

          output="$(helm dependency build 2>&1)" || {
            if echo "$output" | grep -qi "exceeds the maximum allowed size"; then
              echo "⚠️  Dependency build failed due to size limit, continuing"
            else
              echo "❌ Dependency build failed with unexpected error"
              echo "$output"
              exit 1
            fi
          }

      - name: Build render args
        id: args
        shell: bash
        run: |
          set -euo pipefail

          CHART_DIR="${{ inputs.chart_dir || '.' }}"
          VALUES_FILE="${{ inputs.values_file || '' }}"
          KUBE_VERSION="${{ inputs.kube_version || '' }}"
          NAMESPACE="${{ inputs.namespace || 'default' }}"

          ARGS=()
          # Ensure consistent namespace during render
          ARGS+=("--namespace" "${NAMESPACE}")

          if [ -n "${VALUES_FILE}" ]; then
            ARGS+=("-f" "${VALUES_FILE}")
          fi

          if [ -n "${KUBE_VERSION}" ]; then
            ARGS+=("--kube-version" "${KUBE_VERSION}")
          fi

          if [ "${{ inputs.include_crds }}" = "true" ]; then
            ARGS+=("--include-crds")
          fi

          echo "chart_dir=${CHART_DIR}" >> "$GITHUB_OUTPUT"
          echo "args=${ARGS[*]}" >> "$GITHUB_OUTPUT"

      - name: Render manifests
        id: render
        shell: bash
        run: |
          set -euo pipefail
          cd "${{ steps.args.outputs.chart_dir }}"

          if [ ! -f "Chart.yaml" ]; then
            echo "⚠️  Chart.yaml not found in ${{ steps.args.outputs.chart_dir }}"
            echo "Skipping validation - this workflow requires a Helm chart."
            echo "chart_exists=false" >> "$GITHUB_OUTPUT"
            echo "resource_count=0" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "chart_exists=true" >> "$GITHUB_OUTPUT"
          echo "Rendering Helm templates..."
          helm template "${{ inputs.release_name || 'test-release' }}" . ${{ steps.args.outputs.args }} > /tmp/rendered.yaml

          # Count resources by counting apiVersion lines (more reliable than '---')
          COUNT="$(grep -cE '^[[:space:]]*apiVersion:' /tmp/rendered.yaml || true)"
          echo "resource_count=${COUNT}" >> "$GITHUB_OUTPUT"

          echo "Rendered ${COUNT} resource(s)."

      - name: Fail on empty render
        if: ${{ steps.render.outputs.chart_exists == 'true' && inputs.fail_on_empty_render && steps.render.outputs.resource_count == '0' }}
        shell: bash
        run: |
          echo "No Kubernetes resources were rendered. Failing because fail_on_empty_render=true."
          exit 1

      - name: Install yq
        if: ${{ steps.render.outputs.chart_exists == 'true' }}
        # Always install so behavior is consistent across runners
        shell: bash
        run: |
          set -euo pipefail
          YQ_VERSION="v4.47.1"
          curl -fsSL -o /usr/local/bin/yq "https://github.com/mikefarah/yq/releases/download/${YQ_VERSION}/yq_linux_amd64"
          chmod +x /usr/local/bin/yq
          yq --version

      - name: Validate rendered YAML is parseable
        if: ${{ steps.render.outputs.chart_exists == 'true' }}
        shell: bash
        run: |
          set -euo pipefail

          echo "Validating rendered YAML is parseable..."
          # This forces parse of all documents; output discarded
          yq eval-all '.' /tmp/rendered.yaml > /dev/null

          echo "✅ Rendered YAML is parseable"

      - name: Install kubeconform
        if: ${{ steps.render.outputs.chart_exists == 'true' && inputs.enable_kubeconform }}
        shell: bash
        run: |
          set -euo pipefail
          VERSION="v0.6.7"
          curl -fsSL -o /tmp/kubeconform.tar.gz "https://github.com/yannh/kubeconform/releases/download/${VERSION}/kubeconform-linux-amd64.tar.gz"
          tar -xzf /tmp/kubeconform.tar.gz -C /tmp
          sudo mv /tmp/kubeconform /usr/local/bin/kubeconform
          kubeconform -v

      - name: Schema validate rendered manifests (kubeconform)
        if: ${{ steps.render.outputs.chart_exists == 'true' && inputs.enable_kubeconform }}
        shell: bash
        run: |
          set -euo pipefail

          KV="${{ inputs.kubeconform_kubernetes_version }}"
          if [ -z "$KV" ]; then
            KV="${{ inputs.kube_version }}"
          fi

          EXTRA=()
          if [ -n "$KV" ]; then
            EXTRA+=("-kubernetes-version" "$KV")
          fi

          echo "Running kubeconform..."
          # -strict: fail on unknown fields
          # -ignore-missing-schemas: common for CRDs unless you supply schema locations
          kubeconform -strict -ignore-missing-schemas "${EXTRA[@]}" /tmp/rendered.yaml
          echo "✅ kubeconform validation passed"
