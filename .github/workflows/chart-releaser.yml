name: Chart Releaser

on:
  workflow_call:
    inputs:
      charts_dir:
        type: string
        required: false
        default: "."
    secrets:
      cr_token:
        required: true

jobs:
  release:
    name: Chart Releaser
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Configure Git
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: latest

      - name: Determine charts directory
        id: charts-dir
        shell: bash
        run: |
          set -euo pipefail
          INPUT_DIR="${{ inputs.charts_dir }}"
          
          # If the directory contains Chart.yaml directly, it's a specific chart - use parent
          if [ -f "${INPUT_DIR}/Chart.yaml" ]; then
            CHARTS_DIR=$(dirname "${INPUT_DIR}")
            echo "Input points to specific chart, using parent directory: ${CHARTS_DIR}"
          else
            CHARTS_DIR="${INPUT_DIR}"
            echo "Using charts directory: ${CHARTS_DIR}"
          fi
          
          echo "charts_dir=${CHARTS_DIR}" >> "$GITHUB_OUTPUT"
          echo "Final charts directory: ${CHARTS_DIR}"

      - name: Add Helm repositories from chart dependencies
        shell: bash
        run: |
          set -euo pipefail
          CHARTS_DIR="${{ steps.charts-dir.outputs.charts_dir }}"
          
          echo "Scanning for Chart.yaml files in: ${CHARTS_DIR}"
          
          # Extract all repository URLs to a temp file to avoid subshell issues
          REPOS_FILE=$(mktemp)
          
          find "${CHARTS_DIR}" -name "Chart.yaml" -type f | while IFS= read -r chart_file; do
            echo "Checking: ${chart_file}"
            if grep -q "dependencies:" "$chart_file"; then
              echo "Found dependencies in ${chart_file}"
              # Extract repository URLs - handle quoted and unquoted values
              grep -A 50 "dependencies:" "$chart_file" | grep "repository:" | \
                sed -E 's/.*repository:[[:space:]]*["'\'']?([^"'\'']+)["'\'']?[[:space:]]*$/\1/' | \
                grep -E '^https?://' >> "${REPOS_FILE}" || true
            fi
          done
          
          # Add unique repositories
          if [ -s "${REPOS_FILE}" ]; then
            echo "Found repositories:"
            cat "${REPOS_FILE}"
            sort -u "${REPOS_FILE}" | while IFS= read -r repo_url; do
              repo_name=$(echo "$repo_url" | sed 's|https\?://||' | sed 's|/.*||' | sed 's|[^a-zA-Z0-9]|-|g' | tr '[:upper:]' '[:lower:]')
              if ! helm repo list 2>/dev/null | grep -q "^${repo_name}[[:space:]]"; then
                echo "Adding Helm repository: ${repo_name} -> ${repo_url}"
                helm repo add "${repo_name}" "${repo_url}" || true
              else
                echo "Repository ${repo_name} already exists"
              fi
            done
          else
            echo "No repositories found in chart dependencies"
          fi
          
          rm -f "${REPOS_FILE}"
          
          echo "Current Helm repositories:"
          helm repo list || true
          
          if helm repo list 2>/dev/null | grep -q .; then
            echo "Updating Helm repositories..."
            helm repo update || true
          fi

      - name: Run chart-releaser
        uses: helm/chart-releaser-action@v1.7.0
        with:
          charts_dir: ${{ steps.charts-dir.outputs.charts_dir }}
        env:
          CR_TOKEN: "${{ secrets.cr_token }}"
